'ssf-begin
';

'workbook
'   name;find_price_in_matrix.xls/VBAProject

'book-identity

'require

'cells-name
'       ;=PriceMatrix!R1C1:R30C14
'       ;ルールエリア

'worksheet
'   name;Sheet1

'cells-formula
'  address;A1:V18
'     skip;5
'         ;21
'         ;22
'         ;23
'         ;24
'         ;25
'         ;26
'         ;27
'         ;28
'         ;29
'         ;30
'         ;31
'         ;32
'         ;33
'         ;34
'         ;35
'         ;36
'         ;37
'         ;確定単価
'         ;単価計算
'     skip;2
'         ;指定サイトURL
'         ;フラグ
'         ;電話
'         ;住所
'         ;fax
'         ;確認
'         ;記号
'         ;ポイント
'         ;1回目確認URL
'         ;備考
'         ;名前
'         ;事務所
'     skip;3
'         ;2回目確認URL
'     skip;2
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;1
'         ;http://www.yahoo.co.jp/
'         ;3
'         ;888-888-8888
'         ;文京区本郷７－３－１
'         ;777-777-7777
'     skip;3
'         ;http://www.yahoo.co.jp/
'     skip;9
'         ;4
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;2
'         ;http://www.yahoo.co.jp/
'         ;3
'     skip;1
'         ;文京区本郷７－３－１
'         ;777-777-7777
'     skip;3
'         ;http://www.yahoo.co.jp/
'     skip;9
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;3
'         ;http://www.yahoo.co.jp/
'         ;9
'     skip;16
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;4
'         ;http://www.yahoo.co.jp/
'         ;4
'     skip;1
'         ;文京区本郷７－３－１
'         ;777-777-7777
'     skip;3
'         ;http://www.yahoo.co.jp/
'     skip;9
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;5
'         ;http://www.yahoo.co.jp/
'         ;3
'         ;888-888-8888
'     skip;5
'         ;http://www.yahoo.co.jp/
'     skip;9
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;6
'         ;http://www.yahoo.co.jp/
'         ;0
'     skip;16
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;7
'         ;http://www.yahoo.co.jp/
'         ;0
'     skip;16
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;8
'         ;http://www.yahoo.co.jp/
'         ;1
'         ;888-888-8888
'         ;文京区本郷７－３－１
'         ;777-777-7777
'     skip;3
'         ;http://www.yahoo.co.jp/
'     skip;9
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;9
'         ;http://www.yahoo.co.jp/
'         ;1
'     skip;16
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;10
'         ;http://www.yahoo.co.jp/
'         ;0
'     skip;2
'         ;777-777-7777
'     skip;13
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;11
'         ;http://www.yahoo.co.jp/
'         ;2
'     skip;6
'         ;http://www.yahoo.co.jp/
'     skip;9
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;12
'         ;http://www.yahoo.co.jp/
'         ;9
'     skip;16
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;13
'     skip;1
'         ;9
'     skip;16
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;14
'         ;http://www.yahoo.co.jp/
'         ;2
'     skip;2
'         ;777-777-7777
'     skip;3
'         ;http://www.yahoo.co.jp/
'     skip;9
'         ;=RC[1]
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;15
'         ;http://www.yahoo.co.jp/
'         ;0
'     skip;16
'         ;1.5
'         ;=findprice(ルールエリア,RC[4],RC[3]:RC[14])
'     skip;1
'         ;16
'         ;http://www.yahoo.co.jp/
'         ;1
'     skip;1
'         ;文京区本郷７－３－１

'worksheet
'   name;PriceMatrix

'cells-formula
'  address;A1:N3
'         ;１軸
'         ;単価
'         ;２軸ルール
'     skip;14
'         ;1
'         ;2
'         ;3
'         ;4
'         ;5
'         ;6
'         ;7
'         ;8
'         ;9
'         ;10
'         ;11
'         ;フラグ
'     skip;1
'         ;指定サイトURL
'         ;フラグ
'         ;電話
'         ;住所
'         ;fax
'         ;確認
'         ;記号
'         ;ポイント
'         ;1回目確認URL
'         ;備考
'         ;名前
'         ;事務所
'  address;A5:K30
'     skip;1
'         ;2
'         ;1
'     skip;3
'         ;1
'     skip;5
'         ;1.5
'         ;1
'     skip;8
'         ;1
'         ;3.5
'         ;1
'     skip;1
'   repeat;3
'         ;1
'     skip;4
'         ;1
'         ;3
'         ;1
'     skip;1
'   repeat;2
'         ;1
'     skip;5
'         ;1
'         ;3
'         ;1
'     skip;1
'         ;1
'     skip;1
'         ;1
'     skip;4
'         ;1
'         ;2.5
'         ;1
'     skip;1
'         ;1
'     skip;6
'         ;2
'         ;3
'         ;1
'     skip;3
'         ;1
'     skip;3
'         ;1
'         ;2
'         ;2.5
'         ;1
'     skip;7
'         ;1
'         ;3
'         ;5
'         ;1
'     skip;1
'   repeat;3
'         ;1
'     skip;3
'         ;1
'         ;3
'         ;4.5
'         ;1
'     skip;1
'   repeat;2
'         ;1
'     skip;4
'         ;1
'         ;3
'         ;4.5
'         ;1
'     skip;1
'         ;1
'     skip;1
'         ;1
'     skip;3
'         ;1
'         ;3
'         ;4
'         ;1
'     skip;1
'         ;1
'     skip;5
'         ;1
'         ;9
'         ;2
'         ;1
'     skip;8
'         ;9
'         ;1.5
'     skip;9
'         ;4
'         ;5
'         ;1
'     skip;1
'   repeat;3
'         ;1
'     skip;3
'         ;1
'         ;4
'         ;4.5
'         ;1
'     skip;1
'   repeat;2
'         ;1
'     skip;4
'         ;1
'         ;4
'         ;4.5
'         ;1
'     skip;1
'         ;1
'     skip;1
'         ;1
'     skip;3
'         ;1
'   repeat;2
'         ;4
'         ;1
'     skip;1
'         ;1
'     skip;5
'         ;1
'         ;4
'         ;3
'         ;1
'     skip;3
'         ;1
'     skip;3
'         ;1
'         ;4
'         ;2.5
'         ;1
'     skip;7
'         ;1
'         ;4
'         ;3.5
'         ;1
'     skip;1
'   repeat;3
'         ;1
'     skip;4
'         ;4
'         ;3
'         ;1
'     skip;1
'   repeat;2
'         ;1
'     skip;5
'         ;4
'         ;3
'         ;1
'     skip;1
'         ;1
'     skip;1
'         ;1
'     skip;4
'         ;4
'         ;2.5
'         ;1
'     skip;1
'         ;1
'     skip;6
'         ;4
'         ;2
'         ;1
'     skip;8
'         ;4
'         ;1.5

'module
'   name;FindPriceInMatrix
'{{{
Option Explicit

Public Function FindPrice(RuleArea As Range, ByVal Flag As Long, Rules As Range) As Variant
    Dim out As Variant
    Dim Mx As Variant
    Dim MxRow As Variant
    Dim D As Variant
    
    out = 0
    
    SmartArray RuleArea, Rules, Mx, D
    
    For Each MxRow In Mx
        If IsMet1st(MxRow, Flag) Then
            If IsMet2nd(MxRow, D) Then
                out = SelectPrice(MxRow)
                Exit For
            End If
        End If
    Next
    
    FindPrice = out
End Function

Private Function IsMet1st(MxRow As Variant, Flag As Long) As Boolean
    IsMet1st = (Flag = MxRow(1))
End Function

Private Function IsMet2nd(MxRow As Variant, Data As Variant) As Boolean
    Dim i As Long
    
    IsMet2nd = False
    
    For i = 0 To UBound(MxRow(2))
        If Not IsEmpty(MxRow(2)(i)) Then
            If IsEmpty(Data(i)) Then Exit Function
        End If
    Next
    
    IsMet2nd = True
End Function

Private Function SelectPrice(MxRow As Variant) As Variant
    SelectPrice = CDec(MxRow(0))
End Function

Private Function SmartArray(RuleArea As Range, Data As Range, _
        ByRef VarRuleArea As Variant, ByRef VarData As Variant) As Long
    Const MxRstart = 5
    Const MxCstart = 3
    Const MxCprice = 2
    Const MxCflag = 1
    Dim outA() As Variant
    Dim outB() As Variant
    Dim itemA() As Variant
    Dim i As Long
    Dim j As Long
    Dim UpData As Long
    Dim out As Long
    
    ReDim outA(0 To RuleArea.Rows.Count - MxRstart)
    ReDim itemA(0 To RuleArea.Columns.Count - MxCstart)
    ReDim outB(0 To UBound(itemA))
    out = UBound(itemA) + 1
    
    For i = 0 To UBound(outA)
        For j = 0 To UBound(itemA)
            itemA(j) = RuleArea(i + MxRstart, j + MxCstart)
        Next
        outA(i) = Array(RuleArea(i + MxRstart, MxCprice).Value, _
                        RuleArea(i + MxRstart, MxCflag).Value, _
                        itemA)
    Next
    
    UpData = Data.Cells.Count - 1
    For i = 0 To UBound(outB)
        If i > UpData Then Exit For
        outB(i) = Data.Cells(i + 1)
    Next
    
    VarRuleArea = outA
    VarData = outB
    SmartArray = out
End Function


'=== unit test begin ===
#If False Then

Sub test_IsMet1st()
    Debug.Assert IsMet1st(Array(100, 0), 0)
    Debug.Assert Not IsMet1st(Array(100, 0), 1)
    Debug.Assert IsMet1st(Array(100, 1), 1)
    Debug.Assert Not IsMet1st(Array(100, 1), 2)
End Sub

Sub test_IsMet2nd()
    Debug.Assert IsMet2nd(Array(0, 0, Array(1, 1)), Array("a", "a"))
    Debug.Assert IsMet2nd(Array(0, 0, Array(1, Empty, 1)), Array("a", Empty, "a"))
    Debug.Assert IsMet2nd(Array(0, 0, Array(1, Empty, 1)), Array("a", "a", "a"))
    Debug.Assert Not IsMet2nd(Array(0, 0, Array(1, Empty, 1)), Array("a", "a", Empty))
End Sub

Sub test_SelectPrice()
    Debug.Assert SelectPrice(Array(12.3)) = 12.3
End Sub

Sub test_SmartArray()
    Dim x As Range
    Dim y As Range
    Dim a As Variant
    Dim b As Variant
    Dim c As Long
    
    Set x = PriceMatrix.Range("A1:L12")
    Set y = Sheet1.Range("D3:M3")
    
    c = SmartArray(x, y, a, b)
    
    Stop
End Sub

Sub test_FindPrice()
    Dim x As Range
    Dim y As Range
    
    Set x = PriceMatrix.Range("A1:L12")
    Set y = Sheet1.Range("D3:M3")
    
    Debug.Print FindPrice(x, 0, y)
    Debug.Print FindPrice(x, 1, y)
    Debug.Print FindPrice(x, 9, y)
    Debug.Print TypeName(FindPrice(x, 0, y))
    
End Sub

#End If
'=== unit test end ===

'}}}

'ssf-end

