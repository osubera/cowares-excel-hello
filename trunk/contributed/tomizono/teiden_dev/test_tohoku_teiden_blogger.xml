<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
  <ModulePrefs
      title="__MSG_tohoku_teiden__"
      directory_title="__MSG_tohoku_teiden_dir__"
      description="__MSG_tohoku_teiden_desc__"
      author="Tomizono"
      author_email="cowares+tohokuteiden+6@gmail.com"
      author_link="http://cowares.nobody.jp"
      author_photo="http://cowares-excel-hello.googlecode.com/svn/trunk/contributed/tomizono/teiden_dev/i.png"
      author_location="__MSG_location__"
      author_affiliation="kobobau"
      author_aboutme="__MSG_aboutme__"
      author_quote="__MSG_quote__"
      screenshot="http://cowares-excel-hello.googlecode.com/svn/trunk/contributed/tomizono/teiden_dev/tohoku-epco-blackout-schedule.png"
      thumbnail="http://cowares-excel-hello.googlecode.com/svn/trunk/contributed/tomizono/teiden_dev/tohoku-epco-blackout-schedule-s.png"
      title_url="http://cowares-excel-hello.googlecode.com/svn/trunk/contributed/tomizono/teiden_dev/"
      height="64">
    <Locale messages="http://cowares-excel-hello.googlecode.com/svn/trunk/contributed/tomizono/teiden_dev/ALL_ALL.xml" />
    <Locale lang="ja" messages="http://cowares-excel-hello.googlecode.com/svn/trunk/contributed/tomizono/teiden_dev/ja_ALL.xml" />
    <Require feature="dynamic-height" />
    <Require feature="setprefs" />
  </ModulePrefs>
  <UserPref name="days" display_name="Number of Days" datatype="string" default_value="1" />
  <UserPref name="hour" display_name="Offset Hour" datatype="string" default_value="5" />
  <Content type="html" view="home,profile,default,canvas,preview">
    <![CDATA[ 
      <!-- Copyright (c) 2011 Fortitudinous, Free, Fair cowares.nobody.jp -->
      <style type="text/css">
        table{font-size:13px;} th,td{border-width:0px 1px 0px 0px;border-style:dotted;border-color:#ccc;}
      </style>
      <div id="kontena__MODULE_ID__">
      </div>
      <script type="text/javascript">
        // tohoku epco blackout schedules
        // http://www.tohoku-epco.co.jp.cache.yimg.jp/information/1182377_821.html
        
        (function(){
          function scheduleUrl() {
            return('http://www.tohoku-epco.co.jp.cache.yimg.jp/information/1182377_821.html');
          }
          
          function getDate(offsetDay, offsetHour) {
            var now = new Date();
            var year = now.getFullYear();
            var month = now.getMonth();
            var date = now.getDate();
            var hour = now.getHours();
            return(convertDate8(new Date(year,month,date+offsetDay,hour+offsetHour,0,0,0)));
          }
          
          function convertDate8(d) {
            var year = d.getFullYear();
            var month = d.getMonth() + 1;
            var date = d.getDate();
            var s = date + '';
            if (date<10) { s = '0' + s; }
            s = month + s;
            if (month<10) { s = '0' + s; }
            s = year + s;
            return(s);
          }
          
          function request(url) {
            var params = {};
            params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
            gadgets.io.makeRequest(url, response, params);
          }
          
          function response(obj) {
            var schedules = reformSchedules(cutSchedules(obj.text));
            var header = schedules.shift();
            var scheduleFinder = toHashArray(schedules);
            var prefs = new _IG_Prefs();
            var offsetHour = prefs.getInt('hour');
            var numberDays = prefs.getInt('days');
            var container = document.getElementById('kontena__MODULE_ID__');
            var out = '';
            out = makeDefaultHtml(container, header, scheduleFinder, offsetHour, numberDays);
            container.innerHTML = out;
            gadgets.window.adjustHeight(container.style.height);
          };
          
          function makeDefaultHtml(container, header, scheduleFinder, offsetHour, numberDays) {
            var key = 'd' + getDate(0,offsetHour);
            
            var schedule = scheduleFinder[key];
            if(schedule==undefined) {schedule = new Array('','','');}
            var out = htmlTable(header, schedule, 3);
            return(out);
          }
          
          function htmlTable(header, schedule, columns) {
            var out =  '<table><tr><th>' + header.slice(0,columns).join('</th><th>') + '</th></tr><tr><td>' + schedule.slice(0, columns).join('</td><td>') + '</td></tr></table>';
            return(out);
          }
          
          function toHashArray(lines) {
            // expect Array[[3月19日,a,b,null]]
            // generate Hash['d20110319'] = [3月19日,a,b]
            var out = new Array();
            var now = new Date();
            var year = now.getFullYear();
            var regMD = /[\s　]*(\d+)月[\s　]*(\d+)日/;
            while(lines.length>0) {
              var line = lines.shift();
              if(regMD.exec(line[1]) == null) {continue;}
              var date8 = RegExp.$2;
              if(date8.length<2) { date8 = '0' + date8; }
              date8 = RegExp.$1 + date8;
              if(date8.length<4) { date8 = '0' + date8; }
              date8 = 'd' + year + date8;
              out[date8] = line.slice(1);
            }
            return(out);
          }
          
          function reformSchedules(text) {
            var regSpaces = /(&nbsp;|\s)+/g;
            var noLineFeeds = text.replace(regSpaces, '');
            var splitRows = noLineFeeds.split('</TR>').join('\n');
            var regNoTags = /(<[^<]*>)+/g;
            var magicWord = '````';
            var splitColumns = splitRows.replace(regNoTags, magicWord);
            var schedules = new Array();
            var lines = splitColumns.split('\n');
            while(lines.length>0) {
              var line = lines.shift().split(magicWord);
              if(line.length>=1) {schedules.push(line);}
            }
            return(schedules);
          }
          
          function cutSchedules(text) {
            var tbodies = text.split('TBODY>');
            var out = '';
            for(var i=1;i<tbodies.length;i+=2) {
              out += tbodies[i];
            }
            return(out);
          }
          
          function main() {
            var cacheUrl = gadgets.io.getProxyUrl(scheduleUrl);
            request(cacheUrl);
          }
        
          gadgets.util.registerOnLoadHandler(main);
        })();
      </script>
    ]]>
  </Content>
</Module>